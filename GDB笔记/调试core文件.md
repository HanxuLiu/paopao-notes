## 命令汇总
|命令|作用|
|---|---|
|ulimit -c unlimited|允许生成core文件|
|cat /proc/sys/kernel/core_pattern|查看core文件生成规则|
|sudo bash -c 'echo core.%e.%p > /proc/sys/kernel/core_pattern'|设置core文件生成到当前目录|
|gdb -c core.test|仅调试core文件，无调试符号|
|gdb test core.test|调试core文件并指定对应程序|


## 测试用例

```c
/*================================================================
*  Author: LiuHanxu
*  Date: 2022-12-24
*  Description: 
================================================================*/
#include "stdio.h"
#include <stdlib.h>

void coredump()
{
    char *pStr = "test_coredump";
    printf("Next line will coredump.\n");
    free(pStr);
}

int main()
{
    coredump();
    return 0;
}
```


## 允许生成core文件`ulimit -c unlimited`
查看发现系统core文件设置大小为0，不会生成core文件，`ulimit -c unlimited`设置后才会生成core文件。
```
lhx@ubuntu:~/paopao-notes/code$ ulimit -a | grep core
core file size          (blocks, -c) 0
lhx@ubuntu:~/paopao-notes/code$ ulimit -c unlimited
lhx@ubuntu:~/paopao-notes/code$ ulimit -a | grep core
core file size          (blocks, -c) unlimited
```

```
lhx@ubuntu:~/paopao-notes/code$ ./test_coredump 
Next line will coredump.
free(): invalid pointer
已放弃 (核心已转储)
```

正常情况下core文件会生成在当前目录，有些系统设置不同，导致core文件生成到其他目录。如果当前目录没有找到 core 文件，使用命令`cat /proc/sys/kernel/core_pattern`却看到 /usr/share/apport/apport 类似的路径，注意这表示Ubuntu 下 coredump 会被 Apport 来处理，此时 core 文件会生成到 /var/lib/apport/coredump/ 目录里。

```
lhx@ubuntu:~/paopao-notes/code$ cat /proc/sys/kernel/core_pattern
|/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E
lhx@ubuntu:~/paopao-notes/code$ 
lhx@ubuntu:~/paopao-notes/code$ ls /var/lib/apport/coredump/
core._home_lhx_paopao-notes_code_test_coredump.1000.e6e4eff9-9fce-47b6-a2b2-5d33f657409e.2638.262551
lhx@ubuntu:~/paopao-notes/code$
```

也可以修改core_pattern配置，通过命令`sudo bash -c 'echo core.%e.%p`让core文件生成到当前目录。

```
lhx@ubuntu:~/paopao-notes/code$ cat /proc/sys/kernel/core_pattern
|/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E
lhx@ubuntu:~/paopao-notes/code$ sudo bash -c 'echo core.%e.%p > /proc/sys/kernel/core_pattern'
[sudo] lhx 的密码： 
lhx@ubuntu:~/paopao-notes/code$ cat /proc/sys/kernel/core_pattern
core.%e.%p
lhx@ubuntu:~/paopao-notes/code$ ./test_coredump 
Next line will coredump.
free(): invalid pointer
已放弃 (核心已转储)
lhx@ubuntu:~/paopao-notes/code$ ls *test_coredump*
core.test_coredump.2923  test_coredump  test_coredump.c
```

## 调试core文件`gdb test core.test`

如果仅调试core文件`gdb -c core.test`，不指定对应程序的话，则看不到任何调试信息。
```
lhx@ubuntu:~/paopao-notes/code$ gdb -c core.test_coredump.2923 
[New LWP 2923]
Core was generated by `./test_coredump'.
Program terminated with signal SIGABRT, Aborted.
#0  0x00007fbe6fe4900b in ?? ()
(gdb) bt
#0  0x00007fbe6fe4900b in ?? ()
#1  0x0000000000000000 in ?? ()
(gdb)
```

通过`gdb test core.test`同时指定程序和core文件，便会立刻定位到报错位置`at test_coredump.c:13`，即源码第13行，发现是free(pStr)这行代码导致的coredump。然后分析出原因：pStr指针指向的是字符串常量，字符串常量是保存在常量区的，free释放常量区的内存肯定会导致coredump。

```
lhx@ubuntu:~/paopao-notes/code$ gdb test_coredump core.test_coredump.2923 
Reading symbols from test_coredump...
[New LWP 2923]
Core was generated by `./test_coredump'.
Program terminated with signal SIGABRT, Aborted.
#0  0x00007fbe6fe4900b in raise () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007fbe6fe4900b in raise () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007fbe6fe28859 in abort () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007fbe6fe9326e in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#3  0x00007fbe6fe9b2fc in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#4  0x00007fbe6fe9cb2c in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#5  0x0000555587cf4198 in coredump () at test_coredump.c:13
#6  0x0000555587cf41ad in main () at test_coredump.c:18
(gdb) l 13
8	
9	void coredump()
10	{
11	    char *pStr = "test_coredump";
12	    printf("Next line will coredump.\n");
13	    free(pStr);
14	}
15	
16	int main()
17	{
(gdb) 
```

## 调试截图演示

![image-20221224131322077](https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212241313422.png)
